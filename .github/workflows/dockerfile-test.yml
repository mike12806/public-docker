      - name: Smoke test: container runs with default command or shell
        run: |
          image_tag=test-${{ steps.image-name.outputs.name }}:${{ github.sha }}

          if [[ "${{ matrix.dockerfile }}" == *"Runner"* ]]; then
            docker run --rm "$image_tag" python3 --version
            exit $?
          fi

          # Try with /bin/sh and ls / for images that have a shell
          docker run --rm --entrypoint /bin/sh "$image_tag" -c "ls /"
          result=$?
          if [ $result -eq 0 ]; then
            exit 0
          elif [ $result -eq 127 ]; then
            echo "No shell found, running default entrypoint with timeout (for scratch/minimal images)..."
            timeout 10 docker run --rm "$image_tag"
            result=$?
            if [ $result -eq 124 ]; then
              echo "Container hung (timeout)."
              exit 1
            elif [ $result -ne 0 ]; then
              echo "Container failed to start or exited with error."
              exit 1
            fi
            exit 0
          else
            echo "Container test failed."
            exit 1
          fi
